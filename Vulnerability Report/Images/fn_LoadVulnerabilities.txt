// Function: loads vuln JSON from Tenant_A + Tenant_C + Tenant_B folders for a given date tag
let
    LoadVulnJson =
        (dateTag as text) as table =>
        let
            // === Folder paths (Tenant_A, Tenant_C, Tenant_B) ===
            TenantAFolder = "C:\Users\User\Documents\Vulnerability Exports\DefenderExports\Tenant_A",
            TenantCFolder = "C:\Users\User\Documents\Vulnerability Exports\DefenderExports\Tenant_C",
            TenantBFolder = "C:\Users\User\Documents\Vulnerability Exports\DefenderExports\Tenant_B",

            // Helper function to load + parse all JSON/JSON.GZ in a folder whose
            // file name contains the dateTag text. Adds Tenant + SourceBlob columns.
            LoadTenant = (folder as text, tenantName as text) as table =>
                let
                    Files = Folder.Files(folder),

                    // keep only files whose names contain the date tag and are .json or .gz
                    Filtered =
                        Table.SelectRows(
                            Files,
                            each
                                let
                                    fileNameHasDate = Text.Contains([Name], dateTag),
                                    ext = Text.Lower([Extension])
                                in
                                    fileNameHasDate and (ext = ".json" or ext = ".gz")
                        ),

                    // turn JSON (.json or .gz NDJSON) into text
                    WithText =
                        Table.AddColumn(
                            Filtered,
                            "JsonText",
                            each
                                if Text.Lower([Extension]) = ".gz" then
                                    Text.FromBinary(
                                        Binary.Decompress([Content], Compression.GZip),
                                        TextEncoding.Utf8
                                    )
                                else
                                    Text.FromBinary([Content], TextEncoding.Utf8),
                            type text
                        ),

                    // one row per line of NDJSON
                    AsLines       = Table.AddColumn(WithText, "Lines", each Lines.FromText([JsonText])),
                    ExpandedLines = Table.ExpandListColumn(AsLines, "Lines"),

                    // parse each line to a record (skip failures)
                    Parsed =
                        Table.AddColumn(
                            ExpandedLines,
                            "Record",
                            each try Json.Document([Lines]) otherwise null,
                            type any
                        ),
                    KeepRecords = Table.SelectRows(Parsed, each [Record] <> null),

                    // dynamically expand whatever fields exist in the JSON
                    AllCols  = List.Union(List.Transform(KeepRecords[Record], each Record.FieldNames(_))),
                    Expanded = Table.ExpandRecordColumn(KeepRecords, "Record", AllCols, AllCols),

                    // add Tenant + SourceBlob
                    WithTenant = Table.AddColumn(Expanded, "Tenant", each tenantName, type text),
                    WithFile   = Table.AddColumn(WithTenant, "SourceBlob", each [Name], type text),

                    // clean helper columns
                    Clean =
                        Table.RemoveColumns(
                            WithFile,
                            {
                                "Content",
                                "JsonText",
                                "Lines",
                                "Attributes",
                                "Date accessed",
                                "Date created"
                            }
                        )
                in
                    Clean,

            // Load all three tenants
            TenantATable = LoadTenant(TenantAFolder, "Tenant_A"),
            TenantCTable = LoadTenant(TenantCFolder, "Tenant_C"),
            TenantBTable = LoadTenant(TenantBFolder, "Tenant_B"),

            // Combine into one table
            Combined = Table.Combine({TenantATable, TenantCTable, TenantBTable}),

            // Deduplicate: one row per Device + CVE per Tenant
            // (Defender exports one row per software-version; this collapses them)
            Deduped = Table.Distinct(Combined, {"DeviceName", "CveId", "Tenant"})
        in
            Deduped
in
    LoadVulnJson
